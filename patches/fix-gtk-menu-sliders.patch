From b9c154ed207d0c8dfa0929a4df1cf2a269cbb9a1 Mon Sep 17 00:00:00 2001
From: Carlos Garnacho <carlosg@gnome.org>
Date: Thu, 10 Aug 2017 11:56:47 +0200
Subject: [PATCH] menu: Avoid cancelling the menu on GTK+ grabs inside the
 GtkMenu

Allows again sliders as menuitems, broken by commit 9b032073.

Bug: https://bugzilla.gnome.org/show_bug.cgi?id=786029
Bug-Ubuntu: https://launchpad.net/bugs/1712701
Bug-Debian: https://bugs.debian.org/872687
---
 gtk/gtkmenu.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/gtk/gtkmenu.c b/gtk/gtkmenu.c
index 2308040ef2..c443cfeb22 100644
--- a/gtk/gtkmenu.c
+++ b/gtk/gtkmenu.c
@@ -6183,7 +6183,8 @@ gtk_menu_grab_notify (GtkWidget *widget,
   group = gtk_window_get_group (GTK_WINDOW (toplevel));
   grab = gtk_window_group_get_current_grab (group);
 
-  if (GTK_MENU_SHELL (widget)->priv->active && !GTK_IS_MENU_SHELL (grab))
+  if (GTK_MENU_SHELL (widget)->priv->active && !GTK_IS_MENU_SHELL (grab) &&
+      !gtk_widget_is_ancestor (grab, widget))
     gtk_menu_shell_cancel (GTK_MENU_SHELL (widget));
 
   menu->priv->drag_scroll_started = FALSE;
